// schema.prisma - ë‹¤êµ­ì–´ ê³„ì•½ì„œ ì‹œìŠ¤í…œ í™•ì¥ (MediumText ì ìš©)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============ NextAuth + í•µì‹¬ ì‚¬ìš©ì ëª¨ë¸ ============
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // nullable (ì†Œì…œ ë¡œê·¸ì¸ìš©)
  name          String?
  role          String    @default("freelancer")
  
  // NextAuth í•„ìˆ˜ í•„ë“œë“¤
  emailVerified DateTime?
  image         String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // ê¸°ì¡´ ê´€ê³„ë“¤
  profile       Profile?
  services      Service[]
  serviceCategories ServiceCategory[] 
  clients       Client[]
  quotes        Quote[]
  contracts     Contract[]
  reviews       Review[]   @relation("UserReviews")
  portfolio     Portfolio[]
  publicPage    PublicPage?
  uploadedContracts SourceContract[] @relation("UploadedBy")
  reviewedTemplates ContractTemplate[] @relation("ReviewedBy")
  contractTemplates ContractTemplate[]
  sharedServices    SharedService[]
  
  // NextAuth ê´€ê³„
  accounts      Account[]
  sessions      Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============ ê¸°ì¡´ ëª¨ë¸ë“¤ ============

// í”„ë¡œí•„ & ì†Œê°œ
model Profile {
  id          Int     @id @default(autoincrement())
  userId      String  @unique
  
  // ë‹´ë‹¹ì ì •ë³´
  contactName  String?
  contactPhone String?
  contactEmail String?
  
  // íšŒì‚¬ ì •ë³´
  companyName    String?
  ceoName        String?
  businessNumber String?
  companyPhone   String?
  companyEmail   String?
  companyAddress String?
  businessType   String?
  businessItem   String?
  companyFax     String?
  
  // ì„œëª… ì •ë³´ ì¶”ê°€
  signatureImage String?
  stampImage     String?
  
  // ê¸°ì¡´ í•„ë“œ
  bio         String?  @db.Text
  website     String?
  youtube     String?
  snsLinks    String?  @db.Text
  phone       String?
  address     String?  @db.Text
  profileCard String?  @db.Text
  
  // ê³„ì¢Œ ì •ë³´ ì¶”ê°€
  bankName      String?
  accountNumber String?
  accountHolder String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ì¹´í…Œê³ ë¦¬ ê´€ë¦¬
model ServiceCategory {
  id            String   @id
  userId        String
  name          String
  type          String
  order         Int      @default(0)
  contractTitle String?
  addonOnlyTitle String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  services Service[]
  
  @@unique([userId, id])
}

// ì„œë¹„ìŠ¤ ê´€ë¦¬
model Service {
  id              Int      @id @default(autoincrement())
  userId          String
  categoryId      String
  title           String
  description     String   @db.Text
  price           Float?
  planLevel       String?
  duration        String?
  images          String?  @db.Text
  features        String?  @db.Text
  tags           String?   @db.Text
  deliverables    String?  @db.Text
  packages        String?  @db.Text
  order          Int      @default(0)
  isPlan      Boolean @default(false)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category ServiceCategory @relation(fields: [userId, categoryId], references: [userId, id], onDelete: Cascade)
  quotes   Quote[]
  
  // ê³µìœ  ê´€ë ¨ ì¶”ê°€
  sharedIn SharedService[] @relation("SharedServices")
}

// ê³ ê° ê´€ë¦¬
model Client {
  id        Int      @id @default(autoincrement())
  userId    String
  email     String
  name      String
  phone     String?
  company   String?
  position  String?
  serviceCategory String?
  serviceDescription String? @db.Text
  websiteUrl String?
  memo      String?  @db.Text
  businessNumber String?
  companyAddress String? @db.Text
  companyPhone   String?
  
  // Soft Delete í•„ë“œ ì¶”ê°€
  deleted   Boolean  @default(false)
  deletedAt DateTime?
  
  createdAt DateTime @default(now())
  
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  quotes    Quote[]
  contracts Contract[]
  
  @@unique([userId, email])
}

// ê²¬ì  ê´€ë¦¬
model Quote {
  id          Int      @id @default(autoincrement())
  userId      String?
  clientId    Int?
  serviceId   Int?
  
  // ê¸°ë³¸ ì •ë³´
  title       String?
  status      String   @default("draft")
  amount      Float?
  items       String?  @db.Text
  validUntil  DateTime?
  notes       String?  @db.Text
  
  // AI ê²¬ì  ì§€ì› í•„ë“œ
  type        String   @default("manual")
  metadata    String?  @db.Text
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  client      Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service     Service? @relation(fields: [serviceId], references: [id])
  contracts   Contract[]

  @@map("quotes")
}

// ê³„ì•½ ê´€ë¦¬
model Contract {
  id        Int      @id @default(autoincrement())
  userId    String
  clientId  Int
  quoteId   Int?
  templateId Int?
  
  title     String?
  type      String   @default("manual")
  status    String   @default("pending")
  amount    Float?
  content   String?  @db.MediumText
  metadata  String?  @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  client     Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  quote      Quote?              @relation(fields: [quoteId], references: [id])
  template   ContractTemplate?   @relation(fields: [templateId], references: [id])
  clauses    Clause[]
  signatures Signature[]
  progress   ContractProgress[]
  reviews    Review[]
  signTokens SignToken[]
  checklists ContractChecklist[]
}

// SignToken ëª¨ë¸
model SignToken {
  id         Int      @id @default(autoincrement())
  contractId Int
  token      String   @unique
  signerType String
  email      String
  otp        String?
  otpExpiry  DateTime?
  isUsed     Boolean  @default(false)
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

// ê³„ì•½ ì¡°í•­
model Clause {
  id         Int     @id @default(autoincrement())
  contractId Int
  title      String?
  type       String
  content    String  @db.MediumText
  essential  Boolean @default(false)
  order      Int     @default(0)
  
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

// ì „ìì„œëª…
model Signature {
  id            Int      @id @default(autoincrement())
  contractId    Int
  signerType    String
  signerName    String
  signerEmail   String
  signatureData String?  @db.MediumText
  signatureType String?
  signedAt      DateTime @default(now())
  
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

// ê³„ì•½ ì§„í–‰ìƒí™©
model ContractProgress {
  id         Int     @id @default(autoincrement())
  contractId Int
  task       String
  completed  Boolean @default(false)
  order      Int     @default(0)
  
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

// ê³„ì•½ ì²´í¬ë¦¬ìŠ¤íŠ¸
model ContractChecklist {
  id         Int      @id @default(autoincrement())
  contractId Int
  title      String
  description String?  @db.Text
  category   String
  order      Int      @default(0)
  completed  Boolean  @default(false)
  completedAt DateTime?
  requiresSignature Boolean @default(false)
  signature  String?  @db.MediumText
  signedAt   DateTime?
  createdAt  DateTime @default(now())
  
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

// ë¦¬ë·° & í‰ì 
model Review {
  id         Int      @id @default(autoincrement())
  userId     String
  contractId Int
  rating     Int
  comment    String?  @db.Text
  createdAt  DateTime @default(now())
  
  user     User     @relation("UserReviews", fields: [userId], references: [id], onDelete: Cascade)
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

// í¬íŠ¸í´ë¦¬ì˜¤
model Portfolio {
  id          Int      @id @default(autoincrement())
  userId      String
  title       String
  description String?  @db.Text
  link        String?
  imageUrl    String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ê³µê°œ í˜ì´ì§€
model PublicPage {
  id       Int     @id @default(autoincrement())
  userId   String  @unique
  slug     String  @unique
  theme    String  @default("default")
  isActive Boolean @default(true)
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============ ë‹¤êµ­ì–´ í…œí”Œë¦¿ ì‹œìŠ¤í…œ ============

// ì›ë³¸ ê³„ì•½ì„œ ì €ì¥ì†Œ (ë‹¤êµ­ì–´ í™•ì¥)
model SourceContract {
  id            Int      @id @default(autoincrement())
  filename      String   @unique
  title         String?
  fullText      String   @db.MediumText
  metadata      String?  @db.Text
  clauseCount   Int      @default(0)
  uploadedBy    String
  status        String   @default("uploaded")
  processedAt   DateTime?
  analysisResult String? @db.MediumText
  
  // ğŸŒ ë‹¤êµ­ì–´ í•„ë“œ ì¶”ê°€
  countryCode   String   @default("kr")
  language      String   @default("ko")
  
  createdAt     DateTime @default(now())
  
  uploader User @relation("UploadedBy", fields: [uploadedBy], references: [id])
  candidates ClauseCandidate[]
  
  @@index([countryCode, language])
  @@index([status, countryCode])
}

// ì¡°í•­ í›„ë³´ (ë‹¤êµ­ì–´ í™•ì¥)
model ClauseCandidate {
  id               Int      @id @default(autoincrement())
  title            String
  content          String   @db.MediumText
  contractCategory String
  clauseCategory   String?
  sourceContract   String
  sourceId         Int?
  confidence       Float    @default(0.5)
  tags             String?  @db.Text
  variables        String?  @db.MediumText
  similarity       Float?
  needsReview      Boolean  @default(true)
  reviewedAt       DateTime?
  status           String   @default("pending")
  
  // ğŸŒ ë‹¤êµ­ì–´ í•„ë“œ ì¶”ê°€
  countryCode      String   @default("kr")
  language         String   @default("ko")
  
  createdAt        DateTime @default(now())
  
  source SourceContract? @relation(fields: [sourceId], references: [id], onDelete: SetNull)
  
  @@index([countryCode, language])
  @@index([status, countryCode])
  @@index([clauseCategory, countryCode])
}

// ê³„ì•½ì„œ í…œí”Œë¦¿ (ë‹¤êµ­ì–´ í™•ì¥)
model ContractTemplate {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?  @db.Text
  content      String   @db.MediumText
  category     String
  variables    String?  @db.MediumText
  clauses      String?  @db.MediumText
  status       String   @default("active")
  userId       String
  
  // ê¸°ì¡´ í•„ë“œë“¤
  type         String?
  tags         String?  @db.Text
  industry     String?
  complexity   String?
  confidence   Float    @default(1.0)
  usageCount   Int      @default(0)
  popularity   Float    @default(0.0)
  lastUsed     DateTime?
  reviewedBy   String?
  isActive     Boolean  @default(true)
  
  // ğŸŒ ë‹¤êµ­ì–´ í•„ë“œ ì¶”ê°€
  countryCode  String   @default("kr")
  language     String   @default("ko")
  legalSystem  String   @default("civil_law")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  user         User     @relation(fields: [userId], references: [id])
  reviewer     User?    @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  contracts    Contract[]
  
  @@index([category, status])
  @@index([industry, complexity])
  @@index([popularity])
  @@index([countryCode, language])
  @@index([legalSystem, countryCode])
}

// í…œí”Œë¦¿ ë§¤ì¹­ ë¡œê·¸ (ë‹¤êµ­ì–´ í™•ì¥)
model TemplateMatchLog {
  id            Int      @id @default(autoincrement())
  quoteId       Int?
  contractId    Int?
  industry      String?
  serviceType   String?
  amount        Float?
  complexity    String?
  matchedTemplates String? @db.MediumText
  selectedTemplate Int?
  satisfaction  Int?
  
  // ğŸŒ ë‹¤êµ­ì–´ í•„ë“œ ì¶”ê°€
  countryCode   String   @default("kr")
  language      String   @default("ko")
  
  createdAt     DateTime @default(now())
  
  @@index([countryCode, language])
}

// ============ ë‹¤êµ­ì–´ ì¹´í…Œê³ ë¦¬ ì‹œìŠ¤í…œ ============

// ì¡°í•­ ì¹´í…Œê³ ë¦¬ (ë‹¤êµ­ì–´ í™•ì¥)
model ClauseCategory {
  id          Int      @id @default(autoincrement())
  name        String
  level       Int      @default(1)
  parentId    Int?
  description String?  @db.Text
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  usageCount  Int      @default(0)
  
  // ğŸŒ ë‹¤êµ­ì–´ í•„ë“œ ì¶”ê°€
  countryCode String   @default("kr")
  language    String   @default("ko")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // ìê¸° ì°¸ì¡° ê´€ê³„
  parent   ClauseCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ClauseCategory[] @relation("CategoryHierarchy")
  
  @@index([level, isActive])
  @@index([parentId])
  @@index([countryCode, language])
  @@unique([name, countryCode, language])
}

// ì œì•ˆëœ ì¹´í…Œê³ ë¦¬ (ë‹¤êµ­ì–´ í™•ì¥)
model ProposedCategory {
  id             Int      @id @default(autoincrement())
  name           String
  description    String?  @db.Text
  suggestedBy    String   @default("gpt")
  sourceTemplate String?
  parentId       Int?
  confidence     Float    @default(0.7)
  status         String   @default("pending")
  adminNotes     String?  @db.Text
  
  // ğŸŒ ë‹¤êµ­ì–´ í•„ë“œ ì¶”ê°€
  countryCode    String   @default("kr")
  language       String   @default("ko")
  
  createdAt      DateTime @default(now())
  reviewedAt     DateTime?
  
  @@index([status])
  @@index([suggestedBy])
  @@index([countryCode, language])
}

// ============ ğŸŒ ë‹¤êµ­ì–´ ì‹œìŠ¤í…œ ì‹ ê·œ í…Œì´ë¸” ============

// êµ­ê°€ë³„ ë²•ì  í”„ë¡œíŒŒì¼
model CountryLegalProfile {
  id                    Int      @id @default(autoincrement())
  countryCode           String   @unique
  countryName           String
  language              String
  legalSystem           String
  
  // ë¶„ìŸ í•´ê²° ì„ í˜¸ë„
  preferredDispute      String   @default("court")
  arbitrationPreference Boolean  @default(false)
  
  // í‘œì¤€ ì¡°í•­ ì„¤ì •
  governingLawRequired     Boolean @default(true)
  confidentialityRequired  Boolean @default(true)
  terminationNoticeRequired Boolean @default(true)
  dataProtectionRequired   Boolean @default(false)
  
  // AI ëª¨ë¸ ì„¤ì •
  mlModelPath           String?
  promptTemplate        String?  @db.MediumText
  riskWeights           String?  @db.MediumText // JSON
  
  // ë©”íƒ€ë°ì´í„°
  isActive              Boolean  @default(true)
  templateCount         Int      @default(0)
  lastTrainingDate      DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // ê´€ê³„
  standardClauses       StandardClause[]
  legalTerms           LegalTermDictionary[]
  
  @@index([countryCode])
  @@index([language])
  @@index([legalSystem])
}

// êµ­ê°€ë³„ í‘œì¤€ ì¡°í•­ ë¼ì´ë¸ŒëŸ¬ë¦¬
model StandardClause {
  id                Int      @id @default(autoincrement())
  countryCode       String
  clauseType        String
  title             String
  content           String   @db.MediumText
  
  // ë©”íƒ€ë°ì´í„°
  riskLevel         Int      @default(1)
  isRequired        Boolean  @default(false)
  industrySpecific  String?
  
  // ì‚¬ìš© í†µê³„
  usageCount        Int      @default(0)
  successRate       Float    @default(0.0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  country           CountryLegalProfile @relation(fields: [countryCode], references: [countryCode])
  
  @@index([countryCode, clauseType])
  @@index([riskLevel])
  @@index([isRequired])
}

// êµ­ê°€ë³„ ë²•ì  ìš©ì–´ ì‚¬ì „
model LegalTermDictionary {
  id          Int      @id @default(autoincrement())
  countryCode String
  term        String
  definition  String?  @db.Text
  riskLevel   Int      @default(1)
  alternatives String? @db.MediumText // JSON array
  
  createdAt   DateTime @default(now())
  
  country     CountryLegalProfile @relation(fields: [countryCode], references: [countryCode])
  
  @@unique([countryCode, term])
  @@index([countryCode])
  @@index([riskLevel])
}

// ============ ì„œë¹„ìŠ¤ ê³µìœ  ì‹œìŠ¤í…œ ============

// ê³µìœ ëœ ì„œë¹„ìŠ¤ ë§í¬
model SharedService {
  id            Int      @id @default(autoincrement())
  userId        String
  token         String   @unique
  title         String
  description   String?  @db.Text
  thumbnailImage String?
  
  // OG íƒœê·¸ ì„¤ì •
  ogTitle       String?
  ogDescription String?  @db.Text
  ogImage       String?
  
  // ì ‘ê·¼ ì œì–´
  password      String?
  expiryDate    DateTime?
  isActive      Boolean  @default(true)
  
  // í†µê³„
  viewCount     Int      @default(0)
  lastViewedAt  DateTime?
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // ê´€ê³„
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  services      Service[] @relation("SharedServices")
  views         SharedServiceView[]
  
  @@index([token])
  @@index([userId])
  @@index([isActive])
  @@index([expiryDate])
}

// ê³µìœ  ì„œë¹„ìŠ¤ ì¡°íšŒ ê¸°ë¡
model SharedServiceView {
  id             Int      @id @default(autoincrement())
  sharedServiceId Int
  ipAddress      String
  userAgent      String?  @db.Text
  referer        String?
  viewedAt       DateTime @default(now())
  
  sharedService  SharedService @relation(fields: [sharedServiceId], references: [id], onDelete: Cascade)
  
  @@index([sharedServiceId])
  @@index([viewedAt])
}

// êµ­ê°€ë³„ ì¡°í•­ ì¹´í…Œê³ ë¦¬ ë§¤í•‘ í…Œì´ë¸”
model CountryClauseCategory {
  id           Int      @id @default(autoincrement())
  countryCode  String   // kr, us, de, fr ë“±
  categoryKey  String   // basic, payment, service, delivery ë“± (ì‹œìŠ¤í…œ ë‚´ë¶€ìš©)
  categoryName String   // "ê¸°ë³¸ ì •ë³´", "Payment Terms" ë“± (í‘œì‹œìš©)
  description  String?  @db.Text
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  
  // ì‚¬ìš© í†µê³„
  usageCount   Int      @default(0)
  
  // ë©”íƒ€ë°ì´í„°
  riskWeight   Float    @default(1.0)  // í•´ë‹¹ ì¡°í•­ì˜ ìœ„í—˜ë„ ê°€ì¤‘ì¹˜
  isRequired   Boolean  @default(false) // í•„ìˆ˜ ì¡°í•­ ì—¬ë¶€
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([countryCode, categoryKey])
  @@index([countryCode])
  @@index([categoryKey])
  @@index([isActive])
}